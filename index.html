<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Culture Feed Celebration - Sidebar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #f55838;
      color: #fff;
      overflow: hidden;
      display: flex; justify-content: center; align-items: center;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      transition: background-color 0.5s ease-in-out;
    }

    #display-area {
      width: 95%;
      height: 95%;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: relative;
    }

    .content-wrapper {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
    }

    .content-wrapper.visible {
        opacity: 1;
        transform: scale(1);
    }
    
    .shoutout-main-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
    }

    .recipient {
      font-size: clamp(2rem, 8vw, 6rem); 
      font-weight: 800;
      letter-spacing: -0.02em;
      margin-bottom: 0.25em;
      flex-shrink: 0;
      width: 100%;
      overflow: hidden;
    }

    .message-text {
      /* This large size is the default for normal messages */
      font-size: 5rem; 
      line-height: 1.1;
      font-weight: 600;
      width: 100%;
      flex: 1 1 0;
      min-height: 0; 
      overflow: hidden; 
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .footer-content {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1em;
    }

    .sender {
      font-size: clamp(1.2rem, 4vw, 3rem);
      font-weight: 300;
      font-style: italic;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .hashtag-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5em;
    }

    .hashtag-word {
      display: inline-block;
      word-break: break-word;
    }

    .hashtag-be-different,
    .hashtag-bring-wow,
    .hashtag-build-great {
        font-size: clamp(2rem, 8vw, 6rem); font-weight: 800;
        color: #fff;
    }
    
    #display-area img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

  </style>
</head>
<body>
  <div id="display-area"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

  <script>
    const companyId = 'e62a5679-4687-4594-ab2a-efc7da2872c9';
    const aNectarToken = 'YOUR_JWT_HERE';
    const endpoint = `https://integrations.nectarhr.com/culture-feed?companyId=${companyId}`;
    const headers = { 'Accept': 'application/json', 'a_nectar': aNectarToken };

    const SHOUTOUT_DISPLAY_TIME = 7500;
    const SENDER_DISPLAY_TIME = 4000;
    const FADE_TIME = 800;
    const RETRY_DELAY = 5000;
    const GIF_DISPLAY_TIME = 2000;
    const MIN_FONT_SIZE = 8;
    // NEW: A character threshold to trigger the aggressive shrinking.
    const LONG_MESSAGE_THRESHOLD = 200;

    let shoutouts = [], idx = 0;
    let isFetching = false;

    async function fetchShoutouts() {
      if (isFetching) return;
      isFetching = true;
      try { 
        const timestamp = Date.now(); 
        const urlWithCacheBuster = `${endpoint}&_t=${timestamp}`; 
        const res = await fetch(urlWithCacheBuster, { headers: { ...headers, 'Cache-Control': 'no-cache' } }); 
        if (!res.ok) throw new Error(`HTTP Status: ${res.status}`); 
        const data = await res.json();
        shoutouts = (data.shoutouts && data.shoutouts.length > 0) ? data.shoutouts : [];
      } catch (e) { 
        console.error('Fetch error:', e); 
        shoutouts = [];
      } finally {
        isFetching = false;
      }
    }

    function triggerConfetti() {
        const confettiColors = ['#ffffff', '#ffde2f', '#c85a11'];
        confetti({ particleCount: 70, spread: 80, origin: { y: 0.8 }, colors: confettiColors, scalar: 0.9 });
    }
    
    function adjustFontSize(element) {
        element.style.visibility = 'hidden';
        let fontSize = parseFloat(window.getComputedStyle(element).fontSize);
        while ((element.scrollHeight > element.clientHeight + 1 || element.scrollWidth > element.clientWidth + 1) && fontSize > MIN_FONT_SIZE) {
            fontSize--;
            element.style.fontSize = fontSize + 'px';
        }
        element.style.visibility = 'visible';
    }
    
    async function showShoutout(item) {
        const displayArea = document.getElementById('display-area');

        const runStep = (element, duration, withConfetti = false) => {
            return new Promise(resolve => {
                const wrapper = document.createElement('div');
                wrapper.className = 'content-wrapper';
                wrapper.appendChild(element);
                displayArea.appendChild(wrapper);

                requestAnimationFrame(() => {
                    const elementsToResize = wrapper.querySelectorAll('.recipient, .message-text, .hashtag-word');
                    elementsToResize.forEach(adjustFontSize);
                    
                    setTimeout(() => {
                        wrapper.classList.add('visible');
                        if (withConfetti) triggerConfetti();
                    }, 50);
                });

                setTimeout(() => {
                    wrapper.classList.remove('visible');
                    setTimeout(() => {
                        if (displayArea.contains(wrapper)) {
                            displayArea.removeChild(wrapper);
                        }
                        resolve();
                    }, FADE_TIME);
                }, duration);
            });
        };

        const recipientName = (item.mentionsData[0] && `${item.mentionsData[0].first_name}${item.mentionsData[0].last_name ? ' ' + item.mentionsData[0].last_name : ''}`) || 'To Someone Special';
        const senderName = `â€” ${item.sender.first_name}${item.sender.last_name ? ' ' + item.sender.last_name : ''}`;
        const text = item.command.replace(/^@\w+\s*/, '').replace(/#\w+/g, '').replace(/\+\d+\b/g, '').trim();
        const tags = item.command.match(/#BeDifferent|#BringTheWow|#BuildSomethingGreatTogether/g) || [];
        
        const createHashtagEl = (tag) => {
            const el = document.createElement('div');
            el.className = 'hashtag-word';
            if (tag === '#BeDifferent') el.classList.add('hashtag-be-different');
            else if (tag === '#BringTheWow') el.classList.add('hashtag-bring-wow');
            else if (tag === '#BuildSomethingGreatTogether') el.classList.add('hashtag-build-great');
            el.textContent = tag.replace(/([A-Z])/g, ' $1').trim();
            return el;
        };

        if (text) {
            const shoutoutContent = document.createElement('div');
            shoutoutContent.className = 'shoutout-main-content';
            const recipientEl = document.createElement('div');
            recipientEl.className = 'recipient';
            recipientEl.textContent = recipientName;
            const messageEl = document.createElement('div');
            messageEl.className = 'message-text';
            messageEl.textContent = text;
            
            // *** NEW, DIRECT LOGIC ***
            // If the message is very long, force a much smaller font size as a starting point.
            // This guarantees a visible difference and makes the shrinking process reliable.
            if (text.length > LONG_MESSAGE_THRESHOLD) {
                messageEl.style.fontSize = '22px';
            }
            // *** END OF NEW LOGIC ***

            shoutoutContent.append(recipientEl, messageEl);
            await runStep(shoutoutContent, SHOUTOUT_DISPLAY_TIME, true);

            if (tags.length > 0) {
                const footerEl = document.createElement('div');
                footerEl.className = 'footer-content';
                const hashtagContainer = document.createElement('div');
                hashtagContainer.className = 'hashtag-container';
                tags.forEach(tag => hashtagContainer.appendChild(createHashtagEl(tag)));
                const senderEl = document.createElement('div');
                senderEl.className = 'sender';
                senderEl.textContent = senderName;
                footerEl.append(hashtagContainer, senderEl);
                await runStep(footerEl, SENDER_DISPLAY_TIME, true);
            }
        } else {
            const combinedContent = document.createElement('div');
            combinedContent.className = 'footer-content';
            const recipientEl = document.createElement('div');
            recipientEl.className = 'recipient';
            recipientEl.textContent = recipientName;
            combinedContent.appendChild(recipientEl);
            if (tags.length > 0) {
                const hashtagContainer = document.createElement('div');
                hashtagContainer.className = 'hashtag-container';
                tags.forEach(tag => hashtagContainer.appendChild(createHashtagEl(tag)));
                combinedContent.appendChild(hashtagContainer);
            }
            const senderEl = document.createElement('div');
            senderEl.className = 'sender';
            senderEl.textContent = senderName;
            combinedContent.appendChild(senderEl);
            await runStep(combinedContent, SHOUTOUT_DISPLAY_TIME, true);
        }
    }

    function playGifAnimation() {
        return new Promise(resolve => {
            const displayArea = document.getElementById('display-area');
            const backgroundTransitionDuration = 500;
            document.body.style.backgroundColor = '#ffffff';
            setTimeout(() => {
                displayArea.innerHTML = '';
                const wrapper = document.createElement('div');
                wrapper.className = 'content-wrapper';
                const gif = document.createElement('img');
                gif.src = 'https://raw.githubusercontent.com/pwalkrrs/rrsnectarmini/main/nectarmini.gif?t=' + Date.now();
                wrapper.appendChild(gif);
                displayArea.appendChild(wrapper);
                setTimeout(() => { wrapper.classList.add('visible'); }, 100);
                setTimeout(() => {
                    wrapper.classList.remove('visible');
                    setTimeout(() => {
                        document.body.style.backgroundColor = '#f55838';
                        displayArea.innerHTML = '';
                        resolve();
                    }, FADE_TIME);
                }, GIF_DISPLAY_TIME);
            }, backgroundTransitionDuration);
        });
    }

    async function cycle() {
      if (idx >= shoutouts.length) {
        idx = 0;
        await fetchShoutouts();
        if (shoutouts.length === 0) {
            setTimeout(cycle, RETRY_DELAY);
            return;
        }
      }
      const item = shoutouts[idx];
      await showShoutout(item);
      await playGifAnimation();
      idx++;
      cycle();
    }

    window.addEventListener('load', () => {
      cycle();
      document.body.addEventListener('click', () => {
        window.open('https://app.nectarhr.com/login', '_blank');
      });
    });
  </script>
</body>
</html>

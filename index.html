<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Culture Feed Celebration - Sidebar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #f55838;
      color: #fff;
      overflow: hidden;
      display: flex; justify-content: center; align-items: center;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      /* This transition is the key! We need to wait for it to finish. */
      transition: background-color 0.5s ease-in-out;
    }

    #display-area {
      width: 95%;
      height: 95%;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: relative;
    }

    .content-wrapper {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
    }

    .content-wrapper.visible {
        opacity: 1;
        transform: scale(1);
    }

    .recipient {
      font-size: clamp(2rem, 8vw, 6rem); 
      font-weight: 800;
      letter-spacing: -0.02em;
      margin-bottom: 0.25em;
    }

    .message-text {
      font-size: 10vh;
      line-height: 1.1;
      font-weight: 600;
      width: 100%;
      max-height: 70%; 
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .footer-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1em;
    }

    .sender {
      font-size: clamp(1.2rem, 4vw, 3rem);
      font-weight: 300;
      font-style: italic;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .hashtag-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5em;
    }

    .hashtag-word {
      display: inline-block;
    }

    .hashtag-be-different,
    .hashtag-bring-wow,
    .hashtag-build-great {
        font-size: clamp(2rem, 8vw, 6rem); font-weight: 800;
        color: #fff;
    }
    
    #display-area img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

  </style>
</head>
<body>
  <div id="display-area"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

  <script>
    const companyId = 'e62a5679-4687-4594-ab2a-efc7da2872c9';
    const aNectarToken = 'YOUR_JWT_HERE';
    const endpoint = `https://integrations.nectarhr.com/culture-feed?companyId=${companyId}`;
    const headers = { 'Accept': 'application/json', 'a_nectar': aNectarToken };

    const SHOUTOUT_DISPLAY_TIME = 7500;
    const SENDER_DISPLAY_TIME = 4000;
    const FADE_TIME = 800;
    const RETRY_DELAY = 5000;
    const GIF_DISPLAY_TIME = 2000;

    let shoutouts = [], idx = 0;
    let isFetching = false;

    async function fetchShoutouts() {
      if (isFetching) return;
      isFetching = true;
      console.log('Fetching new shoutouts...');
      try { 
        const timestamp = Date.now(); 
        const urlWithCacheBuster = `${endpoint}&_t=${timestamp}`; 
        const res = await fetch(urlWithCacheBuster, { headers: { ...headers, 'Cache-Control': 'no-cache' } }); 
        if (!res.ok) throw new Error(`HTTP Status: ${res.status}`); 
        const data = await res.json();
        
        if (data.shoutouts && data.shoutouts.length > 0) { 
          shoutouts = data.shoutouts; 
          console.log(`Fetched ${shoutouts.length} shoutouts.`); 
        } else {
          shoutouts = [];
          console.log('No new shoutouts found.');
        }
      } catch (e) { 
        console.error('Fetch error:', e); 
        shoutouts = [];
      } finally {
        isFetching = false;
      }
    }

    function triggerConfetti() {
        const confettiColors = ['#ffffff', '#ffde2f', '#c85a11'];
        confetti({
            particleCount: 70,
            spread: 80,
            origin: { y: 0.8 },
            colors: confettiColors,
            scalar: 0.9
        });
    }
    
    function adjustFontSize(element) {
        const container = element.parentElement;
        let fontSize = parseFloat(window.getComputedStyle(element).fontSize);
        
        while ((element.scrollHeight > container.clientHeight || element.scrollWidth > container.clientWidth) && fontSize > 8) {
            fontSize -= 1;
            element.style.fontSize = `${fontSize}px`;
        }
    }
    
    async function showShoutout(item) {
        const displayArea = document.getElementById('display-area');

        const runStep = (element, duration, withConfetti = false) => {
            return new Promise(resolve => {
                const wrapper = document.createElement('div');
                wrapper.className = 'content-wrapper';
                wrapper.appendChild(element);
                displayArea.appendChild(wrapper);

                setTimeout(() => {
                    wrapper.classList.add('visible');
                    if (withConfetti) {
                        triggerConfetti();
                    }
                }, 100);

                setTimeout(() => {
                    wrapper.classList.remove('visible');
                    setTimeout(() => {
                        displayArea.innerHTML = '';
                        resolve();
                    }, FADE_TIME);
                }, duration);
            });
        };

        await new Promise(resolve => {
            const combinedContentWrapper = document.createElement('div');
            combinedContentWrapper.style.display = 'flex';
            combinedContentWrapper.style.flexDirection = 'column';
            combinedContentWrapper.style.justifyContent = 'center';
            combinedContentWrapper.style.alignItems = 'center';
            combinedContentWrapper.style.height = '100%';
            combinedContentWrapper.style.width = '100%';

            const recipientEl = document.createElement('div');
            recipientEl.className = 'recipient';
            recipientEl.textContent = (item.mentionsData[0] && `${item.mentionsData[0].first_name}${item.mentionsData[0].last_name ? ' ' + item.mentionsData[0].last_name : ''}`) || 'To Someone Special';

            const messageEl = document.createElement('div');
            messageEl.className = 'message-text';
            let text = item.command.replace(/^@\w+\s*/, '').replace(/#\w+/g, '').replace(/\+\d+\b/g, '').trim();
            messageEl.textContent = text;
            
            combinedContentWrapper.appendChild(recipientEl);
            combinedContentWrapper.appendChild(messageEl);

            const wrapper = document.createElement('div');
            wrapper.className = 'content-wrapper';
            wrapper.appendChild(combinedContentWrapper);
            displayArea.appendChild(wrapper);
            
            adjustFontSize(messageEl);
            adjustFontSize(recipientEl);

            setTimeout(() => {
                wrapper.classList.add('visible');
                triggerConfetti();
            }, 100);

            setTimeout(() => {
                wrapper.classList.remove('visible');
                setTimeout(() => {
                    displayArea.innerHTML = '';
                    resolve();
                }, FADE_TIME);
            }, SHOUTOUT_DISPLAY_TIME);
        });

        const tags = item.command.match(/#BeDifferent|#BringTheWow|#BuildSomethingGreatTogether/g) || [];
        if (tags.length > 0) {
            const footerEl = document.createElement('div');
            footerEl.className = 'footer-content';

            const hashtagContainer = document.createElement('div');
            hashtagContainer.className = 'hashtag-container';
            tags.forEach(tag => {
                const hashtagEl = document.createElement('div');
                hashtagEl.className = 'hashtag-word';
                let formattedTag = tag.replace(/([A-Z])/g, ' $1').trim();
                hashtagEl.textContent = formattedTag;
                
                if (tag === '#BeDifferent') hashtagEl.classList.add('hashtag-be-different');
                else if (tag === '#BringTheWow') hashtagEl.classList.add('hashtag-bring-wow');
                else if (tag === '#BuildSomethingGreatTogether') hashtagEl.classList.add('hashtag-build-great');

                hashtagContainer.appendChild(hashtagEl);
            });
            footerEl.appendChild(hashtagContainer);

            const senderEl = document.createElement('div');
            senderEl.className = 'sender';
            senderEl.textContent = `â€” ${item.sender.first_name}${item.sender.last_name ? ' ' + item.sender.last_name : ''}`;
            footerEl.appendChild(senderEl);

            await runStep(footerEl, SENDER_DISPLAY_TIME, true);
        }
    }

    // MODIFIED: This function now waits for the background color transition to finish
    // before showing the GIF, preventing a visual glitch.
    function playGifAnimation() {
        return new Promise(resolve => {
            const displayArea = document.getElementById('display-area');
            const backgroundTransitionDuration = 500; // This must match the CSS transition time for the body

            // Start the background transition to white
            document.body.style.backgroundColor = '#ffffff';

            // Wait for the background to turn fully white before proceeding
            setTimeout(() => {
                displayArea.innerHTML = '';

                const wrapper = document.createElement('div');
                wrapper.className = 'content-wrapper';

                const gif = document.createElement('img');
                gif.src = 'https://raw.githubusercontent.com/pwalkrrs/rrsnectarmini/main/nectarmini.gif?t=' + Date.now();
                
                wrapper.appendChild(gif);
                displayArea.appendChild(wrapper);

                // Fade in the GIF
                setTimeout(() => {
                    wrapper.classList.add('visible');
                }, 100);

                // Set a timer to fade out the GIF
                setTimeout(() => {
                    wrapper.classList.remove('visible');

                    // After the fade out, change the background color back to orange
                    setTimeout(() => {
                        document.body.style.backgroundColor = '#f55838';
                        displayArea.innerHTML = '';
                        resolve();
                    }, FADE_TIME);
                }, GIF_DISPLAY_TIME);

            }, backgroundTransitionDuration);
        });
    }

    async function cycle() {
      if (idx >= shoutouts.length) {
        idx = 0;
        await fetchShoutouts();

        if (shoutouts.length === 0) {
            console.log(`No shoutouts. Retrying in ${RETRY_DELAY / 1000}s.`);
            setTimeout(cycle, RETRY_DELAY);
            return;
        }
      }

      const item = shoutouts[idx];
      console.log(`Showing shoutout ${idx + 1}/${shoutouts.length}`);
      
      await showShoutout(item);
      
      await playGifAnimation();
      
      idx++;
      cycle();
    }

    window.addEventListener('load', () => {
      console.log('Culture Feed Sidebar Display started'); 
      cycle();

      document.body.addEventListener('click', () => {
        window.open('https://app.nectarhr.com/login', '_blank');
      });
    });
    
  </script>
</body>
</html>
